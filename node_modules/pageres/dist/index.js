'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _stream = require('stream');

var _arrayUniq = require('array-uniq');

var _arrayUniq2 = _interopRequireDefault(_arrayUniq);

var _arrayDiffer = require('array-differ');

var _arrayDiffer2 = _interopRequireDefault(_arrayDiffer);

var _easydate = require('easydate');

var _easydate2 = _interopRequireDefault(_easydate);

var _fsWriteStreamAtomic = require('fs-write-stream-atomic');

var _fsWriteStreamAtomic2 = _interopRequireDefault(_fsWriteStreamAtomic);

var _getRes = require('get-res');

var _getRes2 = _interopRequireDefault(_getRes);

var _logSymbols = require('log-symbols');

var _logSymbols2 = _interopRequireDefault(_logSymbols);

var _mem = require('mem');

var _mem2 = _interopRequireDefault(_mem);

var _mkdirp = require('mkdirp');

var _mkdirp2 = _interopRequireDefault(_mkdirp);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

var _screenshotStream = require('screenshot-stream');

var _screenshotStream2 = _interopRequireDefault(_screenshotStream);

var _viewportList = require('viewport-list');

var _viewportList2 = _interopRequireDefault(_viewportList);

var _protocolify = require('protocolify');

var _protocolify2 = _interopRequireDefault(_protocolify);

var _filenamifyUrl = require('filenamify-url');

var _filenamifyUrl2 = _interopRequireDefault(_filenamifyUrl);

var _lodash = require('lodash.template');

var _lodash2 = _interopRequireDefault(_lodash);

var _pify = require('pify');

var _pify2 = _interopRequireDefault(_pify);

var _plur = require('plur');

var _plur2 = _interopRequireDefault(_plur);

var _unusedFilename = require('unused-filename');

var _unusedFilename2 = _interopRequireDefault(_unusedFilename);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const getResMem = (0, _mem2.default)(_getRes2.default);
const viewportListMem = (0, _mem2.default)(_viewportList2.default);

let listener;

class Pageres extends _events2.default {

	constructor(options) {
		super();

		this.options = (0, _assign2.default)({}, options);
		this.options.filename = this.options.filename || '<%= url %>-<%= size %><%= crop %>';
		this.options.format = this.options.format || 'png';
		this.options.incrementalName = this.options.incrementalName || false;

		this.stats = {};
		this.items = [];
		this.sizes = [];
		this.urls = [];
		this._src = [];
	}

	src(url, sizes, options) {
		if (url === undefined) {
			return this._src;
		}

		this._src.push({ url: url, sizes: sizes, options: options });
		return this;
	}

	dest(dir) {
		if (dir === undefined) {
			return this._dest;
		}

		this._dest = dir;
		return this;
	}

	run() {
		var _this = this;

		return (0, _asyncToGenerator3.default)(function* () {
			yield _promise2.default.all(_this.src().map(function (src) {
				// eslint-disable-line array-callback-return
				const options = (0, _assign2.default)({}, _this.options, src.options);
				const sizes = (0, _arrayUniq2.default)(src.sizes.filter(/./.test, /^\d{2,4}x\d{2,4}$/i));
				const keywords = (0, _arrayDiffer2.default)(src.sizes, sizes);

				if (!src.url) {
					throw new Error('URL required');
				}

				_this.urls.push(src.url);

				if (sizes.length === 0 && keywords.indexOf('w3counter') !== -1) {
					return _this.resolution(src.url, options);
				}

				if (keywords.length > 0) {
					return _this.viewport({ url: src.url, sizes: sizes, keywords: keywords }, options);
				}

				for (const size of sizes) {
					_this.sizes.push(size);
					_this.items.push(_this.create(src.url, size, options));
				}
			}));

			_this.stats.urls = (0, _arrayUniq2.default)(_this.urls).length;
			_this.stats.sizes = (0, _arrayUniq2.default)(_this.sizes).length;
			_this.stats.screenshots = _this.items.length;

			if (!_this.dest()) {
				return _this.items;
			}

			yield _this.save(_this.items);

			return _this.items;
		})();
	}

	resolution(url, options) {
		var _this2 = this;

		return (0, _asyncToGenerator3.default)(function* () {
			for (const item of yield getResMem()) {
				_this2.sizes.push(item.item);
				_this2.items.push(_this2.create(url, item.item, options));
			}
		})();
	}

	viewport(obj, options) {
		var _this3 = this;

		return (0, _asyncToGenerator3.default)(function* () {
			for (const item of yield viewportListMem(obj.keywords)) {
				_this3.sizes.push(item.size);
				obj.sizes.push(item.size);
			}

			for (const size of (0, _arrayUniq2.default)(obj.sizes)) {
				_this3.items.push(_this3.create(obj.url, size, options));
			}
		})();
	}

	save(streams) {
		var _this4 = this;

		return (0, _asyncToGenerator3.default)(function* () {
			let end = (() => {
				var _ref = (0, _asyncToGenerator3.default)(function* () {
					return yield _promise2.default.all(files.map(function (file) {
						return (0, _pify2.default)(_rimraf2.default)(file);
					}));
				});

				return function end() {
					return _ref.apply(this, arguments);
				};
			})();

			const files = [];

			if (!listener) {
				listener = process.on('SIGINT', (0, _asyncToGenerator3.default)(function* () {
					yield end();
					process.exit(1);
				}));
			}

			return yield _promise2.default.all(streams.map(function (stream) {
				return new _promise2.default((() => {
					var _ref3 = (0, _asyncToGenerator3.default)(function* (resolve, reject) {
						yield (0, _pify2.default)(_mkdirp2.default)(_this4.dest());

						const dest = _path2.default.join(_this4.dest(), stream.filename);
						const write = (0, _fsWriteStreamAtomic2.default)(dest);

						files.push(write.__atomicTmp);

						stream.on('warning', _this4.emit.bind(_this4, 'warning'));
						stream.on('warn', _this4.emit.bind(_this4, 'warn'));
						stream.on('error', function (err) {
							return end().then(reject(err));
						});

						write.on('finish', resolve);
						write.on('error', function (err) {
							return end().then(reject(err));
						});

						stream.pipe(write);
					});

					return function (_x, _x2) {
						return _ref3.apply(this, arguments);
					};
				})());
			}));
		})();
	}

	create(uri, size, options) {
		const sizes = size.split('x');
		const stream = (0, _screenshotStream2.default)((0, _protocolify2.default)(uri), size, options);

		// Coercing to string here to please Flow
		// TODO: Should fix the Flow type so this isn't necessary
		const filename = (0, _lodash2.default)(`${ String(options.filename) }.${ String(options.format) }`);

		if (_path2.default.isAbsolute(uri)) {
			uri = _path2.default.basename(uri);
		}

		stream.filename = filename({
			crop: options.crop ? '-cropped' : '',
			date: (0, _easydate2.default)('Y-M-d'),
			time: (0, _easydate2.default)('h-m-s'),
			size: size,
			width: sizes[0],
			height: sizes[1],
			url: (0, _filenamifyUrl2.default)(uri)
		});

		if (options.incrementalName) {
			stream.filename = _unusedFilename2.default.sync(stream.filename);
		}

		return stream;
	}

	successMessage() {
		const stats = this.stats;
		const screenshots = stats.screenshots,
		      sizes = stats.sizes,
		      urls = stats.urls;

		const words = {
			screenshots: (0, _plur2.default)('screenshot', screenshots),
			sizes: (0, _plur2.default)('size', sizes),
			urls: (0, _plur2.default)('url', urls)
		};

		console.log(`\n${ _logSymbols2.default.success } Generated ${ screenshots } ${ words.screenshots } from ${ urls } ${ words.urls } and ${ sizes } ${ words.sizes }`);
	}
}
exports.default = Pageres;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9pbmRleC5qcyJdLCJuYW1lcyI6WyJnZXRSZXNNZW0iLCJ2aWV3cG9ydExpc3RNZW0iLCJsaXN0ZW5lciIsIlBhZ2VyZXMiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJmaWxlbmFtZSIsImZvcm1hdCIsImluY3JlbWVudGFsTmFtZSIsInN0YXRzIiwiaXRlbXMiLCJzaXplcyIsInVybHMiLCJfc3JjIiwic3JjIiwidXJsIiwidW5kZWZpbmVkIiwicHVzaCIsImRlc3QiLCJkaXIiLCJfZGVzdCIsInJ1biIsImFsbCIsIm1hcCIsImZpbHRlciIsInRlc3QiLCJrZXl3b3JkcyIsIkVycm9yIiwibGVuZ3RoIiwiaW5kZXhPZiIsInJlc29sdXRpb24iLCJ2aWV3cG9ydCIsInNpemUiLCJjcmVhdGUiLCJzY3JlZW5zaG90cyIsInNhdmUiLCJpdGVtIiwib2JqIiwic3RyZWFtcyIsImZpbGVzIiwiZmlsZSIsImVuZCIsInByb2Nlc3MiLCJvbiIsImV4aXQiLCJyZXNvbHZlIiwicmVqZWN0Iiwiam9pbiIsInN0cmVhbSIsIndyaXRlIiwiX19hdG9taWNUbXAiLCJlbWl0IiwiYmluZCIsInRoZW4iLCJlcnIiLCJwaXBlIiwidXJpIiwic3BsaXQiLCJTdHJpbmciLCJpc0Fic29sdXRlIiwiYmFzZW5hbWUiLCJjcm9wIiwiZGF0ZSIsInRpbWUiLCJ3aWR0aCIsImhlaWdodCIsInN5bmMiLCJzdWNjZXNzTWVzc2FnZSIsIndvcmRzIiwiY29uc29sZSIsImxvZyIsInN1Y2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUEwQ0EsTUFBTUEsWUFBWSxvQ0FB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Y3lDLEdBQWQ7QUFQcUIsR0FBVCxDQUFsQjs7QUFVQSxNQUFJbkQsUUFBUUcsZUFBWixFQUE2QjtBQUM1QndDLFVBQU8xQyxRQUFQLEdBQWtCLHlCQUFlNEQsSUFBZixDQUFvQmxCLE9BQU8xQyxRQUEzQixDQUFsQjtBQUNBOztBQUVELFNBQU8wQyxNQUFQO0FBQ0E7O0FBRURtQixrQkFBaUI7QUFDaEIsUUFBTTFELFFBQVEsS0FBS0EsS0FBbkI7QUFEZ0IsUUFFVHlCLFdBRlMsR0FFbUJ6QixLQUZuQixDQUVUeUIsV0FGUztBQUFBLFFBRUl2QixLQUZKLEdBRW1CRixLQUZuQixDQUVJRSxLQUZKO0FBQUEsUUFFV0MsSUFGWCxHQUVtQkgsS0FGbkIsQ0FFV0csSUFGWDs7QUFHaEIsUUFBTXdELFFBQVE7QUFDYmxDLGdCQUFhLG9CQUFLLFlBQUwsRUFBbUJBLFdBQW5CLENBREE7QUFFYnZCLFVBQU8sb0JBQUssTUFBTCxFQUFhQSxLQUFiLENBRk07QUFHYkMsU0FBTSxvQkFBSyxLQUFMLEVBQVlBLElBQVo7QUFITyxHQUFkOztBQU1BeUQsVUFBUUMsR0FBUixDQUFhLE1BQUkscUJBQVdDLE9BQVEsZ0JBQWFyQyxXQUFZLE1BQUdrQyxNQUFNbEMsV0FBWSxXQUFRdEIsSUFBSyxNQUFHd0QsTUFBTXhELElBQUssVUFBT0QsS0FBTSxNQUFHeUQsTUFBTXpELEtBQU0sR0FBekk7QUFDQTtBQS9LbUU7a0JBQWhEUixPIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IHtSZWFkYWJsZX0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCBhcnJheVVuaXEgZnJvbSAnYXJyYXktdW5pcSc7XG5pbXBvcnQgYXJyYXlEaWZmZXIgZnJvbSAnYXJyYXktZGlmZmVyJztcbmltcG9ydCBlYXN5ZGF0ZSBmcm9tICdlYXN5ZGF0ZSc7XG5pbXBvcnQgZnNXcml0ZVN0cmVhbUF0b21pYyBmcm9tICdmcy13cml0ZS1zdHJlYW0tYXRvbWljJztcbmltcG9ydCBnZXRSZXMgZnJvbSAnZ2V0LXJlcyc7XG5pbXBvcnQgbG9nU3ltYm9scyBmcm9tICdsb2ctc3ltYm9scyc7XG5pbXBvcnQgbWVtIGZyb20gJ21lbSc7XG5pbXBvcnQgbWtkaXJwIGZyb20gJ21rZGlycCc7XG5pbXBvcnQgcmltcmFmIGZyb20gJ3JpbXJhZic7XG5pbXBvcnQgc2NyZWVuc2hvdFN0cmVhbSBmcm9tICdzY3JlZW5zaG90LXN0cmVhbSc7XG5pbXBvcnQgdmlld3BvcnRMaXN0IGZyb20gJ3ZpZXdwb3J0LWxpc3QnO1xuaW1wb3J0IHByb3RvY29saWZ5IGZyb20gJ3Byb3RvY29saWZ5JztcbmltcG9ydCBmaWxlbmFtaWZ5VXJsIGZyb20gJ2ZpbGVuYW1pZnktdXJsJztcbmltcG9ydCB0ZW1wbGF0ZSBmcm9tICdsb2Rhc2gudGVtcGxhdGUnO1xuaW1wb3J0IHBpZnkgZnJvbSAncGlmeSc7XG5pbXBvcnQgcGx1ciBmcm9tICdwbHVyJztcbmltcG9ydCB1bnVzZWRGaWxlbmFtZSBmcm9tICd1bnVzZWQtZmlsZW5hbWUnO1xuXG50eXBlIFBhZ2VyZXNTdHJlYW0gPSBSZWFkYWJsZSAmIHtmaWxlbmFtZTogc3RyaW5nfTtcblxudHlwZSBPcHRpb25zID0ge1xuXHRkZWxheT86IG51bWJlcjtcblx0dGltZW91dD86IG51bWJlcjtcblx0Y3JvcD86IGJvb2xlYW47XG5cdGluY3JlbWVudGFsTmFtZT86IGJvb2xlYW47XG5cdGNzcz86IHN0cmluZztcblx0Y29va2llcz86IEFycmF5PHN0cmluZz4gfCB7W2tleTogc3RyaW5nXTogc3RyaW5nfTtcblx0ZmlsZW5hbWU/OiBzdHJpbmc7XG5cdHNlbGVjdG9yPzogc3RyaW5nO1xuXHRoaWRlPzogQXJyYXk8c3RyaW5nPjtcblx0dXNlcm5hbWU/OiBzdHJpbmc7XG5cdHBhc3N3b3JkPzogc3RyaW5nO1xuXHRzY2FsZT86IG51bWJlcjtcblx0Zm9ybWF0Pzogc3RyaW5nO1xuXHR1c2VyQWdlbnQ/OiBzdHJpbmc7XG5cdGhlYWRlcnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nfTtcbn07XG5cbnR5cGUgU3JjID0ge1xuXHR1cmw6IHN0cmluZztcblx0c2l6ZXM6IEFycmF5PHN0cmluZz47XG5cdG9wdGlvbnM6IE9wdGlvbnM7XG59O1xuXG50eXBlIFZpZXdwb3J0ID0ge1xuXHR1cmw6IHN0cmluZztcblx0c2l6ZXM6IEFycmF5PHN0cmluZz47XG5cdGtleXdvcmRzOiBBcnJheTxzdHJpbmc+O1xufTtcblxudHlwZSBTcmNGbjxEZXN0VmFsdWU+ID1cblx0JiAoKF86IHZvaWQsIF86IHZvaWQsIF86IHZvaWQpID0+IEFycmF5PFNyYz4pXG5cdCYgKCh1cmw6IHN0cmluZywgc2l6ZXM6IEFycmF5PHN0cmluZz4sIG9wdGlvbnM6IE9wdGlvbnMpID0+IFBhZ2VyZXM8RGVzdFZhbHVlPik7XG5cbnR5cGUgRGVzdEZuPERlc3RWYWx1ZT4gPVxuXHQmICgoXzogdm9pZCkgPT4gRGVzdFZhbHVlKVxuXHQmICgoZGlyOiBEZXN0VmFsdWUpID0+IFBhZ2VyZXM8RGVzdFZhbHVlPik7XG5cbmNvbnN0IGdldFJlc01lbSA9IG1lbShnZXRSZXMpO1xuY29uc3Qgdmlld3BvcnRMaXN0TWVtID0gbWVtKHZpZXdwb3J0TGlzdCk7XG5cbmxldCBsaXN0ZW5lcjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGFnZXJlczxEZXN0VmFsdWU6IHN0cmluZz4gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuXHRvcHRpb25zOiBPcHRpb25zO1xuXHRzdGF0czogT2JqZWN0O1xuXHRpdGVtczogQXJyYXk8UGFnZXJlc1N0cmVhbT47XG5cdHNpemVzOiBBcnJheTxzdHJpbmc+O1xuXHR1cmxzOiBBcnJheTxzdHJpbmc+O1xuXHRfc3JjOiBBcnJheTxTcmM+O1xuXHRfZGVzdDogRGVzdFZhbHVlO1xuXG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG5cdFx0dGhpcy5vcHRpb25zLmZpbGVuYW1lID0gdGhpcy5vcHRpb25zLmZpbGVuYW1lIHx8ICc8JT0gdXJsICU+LTwlPSBzaXplICU+PCU9IGNyb3AgJT4nO1xuXHRcdHRoaXMub3B0aW9ucy5mb3JtYXQgPSB0aGlzLm9wdGlvbnMuZm9ybWF0IHx8ICdwbmcnO1xuXHRcdHRoaXMub3B0aW9ucy5pbmNyZW1lbnRhbE5hbWUgPSB0aGlzLm9wdGlvbnMuaW5jcmVtZW50YWxOYW1lIHx8IGZhbHNlO1xuXG5cdFx0dGhpcy5zdGF0cyA9IHt9O1xuXHRcdHRoaXMuaXRlbXMgPSBbXTtcblx0XHR0aGlzLnNpemVzID0gW107XG5cdFx0dGhpcy51cmxzID0gW107XG5cdFx0dGhpcy5fc3JjID0gW107XG5cdH1cblxuXHRzcmM6IFNyY0ZuPERlc3RWYWx1ZT47XG5cdHNyYyh1cmw6IHN0cmluZywgc2l6ZXM6IEFycmF5PHN0cmluZz4sIG9wdGlvbnM6IE9wdGlvbnMpIHtcblx0XHRpZiAodXJsID09PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiB0aGlzLl9zcmM7XG5cdFx0fVxuXG5cdFx0dGhpcy5fc3JjLnB1c2goe3VybCwgc2l6ZXMsIG9wdGlvbnN9KTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGRlc3Q6IERlc3RGbjxEZXN0VmFsdWU+O1xuXHRkZXN0KGRpcjogRGVzdFZhbHVlKSB7XG5cdFx0aWYgKGRpciA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fZGVzdDtcblx0XHR9XG5cblx0XHR0aGlzLl9kZXN0ID0gZGlyO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YXN5bmMgcnVuKCk6IFByb21pc2U8UGFnZXJlc1N0cmVhbVtdPiB7XG5cdFx0YXdhaXQgUHJvbWlzZS5hbGwodGhpcy5zcmMoKS5tYXAoc3JjID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBhcnJheS1jYWxsYmFjay1yZXR1cm5cblx0XHRcdGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdGlvbnMsIHNyYy5vcHRpb25zKTtcblx0XHRcdGNvbnN0IHNpemVzID0gYXJyYXlVbmlxKHNyYy5zaXplcy5maWx0ZXIoLy4vLnRlc3QsIC9eXFxkezIsNH14XFxkezIsNH0kL2kpKTtcblx0XHRcdGNvbnN0IGtleXdvcmRzID0gYXJyYXlEaWZmZXIoc3JjLnNpemVzLCBzaXplcyk7XG5cblx0XHRcdGlmICghc3JjLnVybCkge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1VSTCByZXF1aXJlZCcpO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLnVybHMucHVzaChzcmMudXJsKTtcblxuXHRcdFx0aWYgKHNpemVzLmxlbmd0aCA9PT0gMCAmJiBrZXl3b3Jkcy5pbmRleE9mKCd3M2NvdW50ZXInKSAhPT0gLTEpIHtcblx0XHRcdFx0cmV0dXJuIHRoaXMucmVzb2x1dGlvbihzcmMudXJsLCBvcHRpb25zKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGtleXdvcmRzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0cmV0dXJuIHRoaXMudmlld3BvcnQoe3VybDogc3JjLnVybCwgc2l6ZXMsIGtleXdvcmRzfSwgb3B0aW9ucyk7XG5cdFx0XHR9XG5cblx0XHRcdGZvciAoY29uc3Qgc2l6ZSBvZiBzaXplcykge1xuXHRcdFx0XHR0aGlzLnNpemVzLnB1c2goc2l6ZSk7XG5cdFx0XHRcdHRoaXMuaXRlbXMucHVzaCh0aGlzLmNyZWF0ZShzcmMudXJsLCBzaXplLCBvcHRpb25zKSk7XG5cdFx0XHR9XG5cdFx0fSkpO1xuXG5cdFx0dGhpcy5zdGF0cy51cmxzID0gYXJyYXlVbmlxKHRoaXMudXJscykubGVuZ3RoO1xuXHRcdHRoaXMuc3RhdHMuc2l6ZXMgPSBhcnJheVVuaXEodGhpcy5zaXplcykubGVuZ3RoO1xuXHRcdHRoaXMuc3RhdHMuc2NyZWVuc2hvdHMgPSB0aGlzLml0ZW1zLmxlbmd0aDtcblxuXHRcdGlmICghdGhpcy5kZXN0KCkpIHtcblx0XHRcdHJldHVybiB0aGlzLml0ZW1zO1xuXHRcdH1cblxuXHRcdGF3YWl0IHRoaXMuc2F2ZSh0aGlzLml0ZW1zKTtcblxuXHRcdHJldHVybiB0aGlzLml0ZW1zO1xuXHR9XG5cblx0YXN5bmMgcmVzb2x1dGlvbih1cmw6IHN0cmluZywgb3B0aW9uczogT3B0aW9ucykge1xuXHRcdGZvciAoY29uc3QgaXRlbSBvZiBhd2FpdCBnZXRSZXNNZW0oKSkge1xuXHRcdFx0dGhpcy5zaXplcy5wdXNoKGl0ZW0uaXRlbSk7XG5cdFx0XHR0aGlzLml0ZW1zLnB1c2godGhpcy5jcmVhdGUodXJsLCBpdGVtLml0ZW0sIG9wdGlvbnMpKTtcblx0XHR9XG5cdH1cblxuXHRhc3luYyB2aWV3cG9ydChvYmo6IFZpZXdwb3J0LCBvcHRpb25zOiBPcHRpb25zKSB7XG5cdFx0Zm9yIChjb25zdCBpdGVtIG9mIGF3YWl0IHZpZXdwb3J0TGlzdE1lbShvYmoua2V5d29yZHMpKSB7XG5cdFx0XHR0aGlzLnNpemVzLnB1c2goaXRlbS5zaXplKTtcblx0XHRcdG9iai5zaXplcy5wdXNoKGl0ZW0uc2l6ZSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCBzaXplIG9mIGFycmF5VW5pcShvYmouc2l6ZXMpKSB7XG5cdFx0XHR0aGlzLml0ZW1zLnB1c2godGhpcy5jcmVhdGUob2JqLnVybCwgc2l6ZSwgb3B0aW9ucykpO1xuXHRcdH1cblx0fVxuXG5cdGFzeW5jIHNhdmUoc3RyZWFtczogQXJyYXk8UGFnZXJlc1N0cmVhbT4pIHtcblx0XHRjb25zdCBmaWxlcyA9IFtdO1xuXG5cdFx0YXN5bmMgZnVuY3Rpb24gZW5kKCkge1xuXHRcdFx0cmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKGZpbGVzLm1hcChmaWxlID0+IHBpZnkocmltcmFmKShmaWxlKSkpO1xuXHRcdH1cblxuXHRcdGlmICghbGlzdGVuZXIpIHtcblx0XHRcdGxpc3RlbmVyID0gcHJvY2Vzcy5vbignU0lHSU5UJywgYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRhd2FpdCBlbmQoKTtcblx0XHRcdFx0cHJvY2Vzcy5leGl0KDEpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHN0cmVhbXMubWFwKHN0cmVhbSA9PlxuXHRcdFx0bmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRhd2FpdCBwaWZ5KG1rZGlycCkodGhpcy5kZXN0KCkpO1xuXG5cdFx0XHRcdGNvbnN0IGRlc3QgPSBwYXRoLmpvaW4odGhpcy5kZXN0KCksIHN0cmVhbS5maWxlbmFtZSk7XG5cdFx0XHRcdGNvbnN0IHdyaXRlID0gZnNXcml0ZVN0cmVhbUF0b21pYyhkZXN0KTtcblxuXHRcdFx0XHRmaWxlcy5wdXNoKHdyaXRlLl9fYXRvbWljVG1wKTtcblxuXHRcdFx0XHRzdHJlYW0ub24oJ3dhcm5pbmcnLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnd2FybmluZycpKTtcblx0XHRcdFx0c3RyZWFtLm9uKCd3YXJuJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ3dhcm4nKSk7XG5cdFx0XHRcdHN0cmVhbS5vbignZXJyb3InLCBlcnIgPT4gZW5kKCkudGhlbihyZWplY3QoZXJyKSkpO1xuXG5cdFx0XHRcdHdyaXRlLm9uKCdmaW5pc2gnLCByZXNvbHZlKTtcblx0XHRcdFx0d3JpdGUub24oJ2Vycm9yJywgZXJyID0+IGVuZCgpLnRoZW4ocmVqZWN0KGVycikpKTtcblxuXHRcdFx0XHRzdHJlYW0ucGlwZSh3cml0ZSk7XG5cdFx0XHR9KVxuXHRcdCkpO1xuXHR9XG5cblx0Y3JlYXRlKHVyaTogc3RyaW5nLCBzaXplOiBzdHJpbmcsIG9wdGlvbnM6IE9wdGlvbnMpIHtcblx0XHRjb25zdCBzaXplcyA9IHNpemUuc3BsaXQoJ3gnKTtcblx0XHRjb25zdCBzdHJlYW0gPSBzY3JlZW5zaG90U3RyZWFtKHByb3RvY29saWZ5KHVyaSksIHNpemUsIG9wdGlvbnMpO1xuXG5cdFx0Ly8gQ29lcmNpbmcgdG8gc3RyaW5nIGhlcmUgdG8gcGxlYXNlIEZsb3dcblx0XHQvLyBUT0RPOiBTaG91bGQgZml4IHRoZSBGbG93IHR5cGUgc28gdGhpcyBpc24ndCBuZWNlc3Nhcnlcblx0XHRjb25zdCBmaWxlbmFtZSA9IHRlbXBsYXRlKGAke1N0cmluZyhvcHRpb25zLmZpbGVuYW1lKX0uJHtTdHJpbmcob3B0aW9ucy5mb3JtYXQpfWApO1xuXG5cdFx0aWYgKHBhdGguaXNBYnNvbHV0ZSh1cmkpKSB7XG5cdFx0XHR1cmkgPSBwYXRoLmJhc2VuYW1lKHVyaSk7XG5cdFx0fVxuXG5cdFx0c3RyZWFtLmZpbGVuYW1lID0gZmlsZW5hbWUoe1xuXHRcdFx0Y3JvcDogb3B0aW9ucy5jcm9wID8gJy1jcm9wcGVkJyA6ICcnLFxuXHRcdFx0ZGF0ZTogZWFzeWRhdGUoJ1ktTS1kJyksXG5cdFx0XHR0aW1lOiBlYXN5ZGF0ZSgnaC1tLXMnKSxcblx0XHRcdHNpemUsXG5cdFx0XHR3aWR0aDogc2l6ZXNbMF0sXG5cdFx0XHRoZWlnaHQ6IHNpemVzWzFdLFxuXHRcdFx0dXJsOiBmaWxlbmFtaWZ5VXJsKHVyaSlcblx0XHR9KTtcblxuXHRcdGlmIChvcHRpb25zLmluY3JlbWVudGFsTmFtZSkge1xuXHRcdFx0c3RyZWFtLmZpbGVuYW1lID0gdW51c2VkRmlsZW5hbWUuc3luYyhzdHJlYW0uZmlsZW5hbWUpO1xuXHRcdH1cblxuXHRcdHJldHVybiBzdHJlYW07XG5cdH1cblxuXHRzdWNjZXNzTWVzc2FnZSgpIHtcblx0XHRjb25zdCBzdGF0cyA9IHRoaXMuc3RhdHM7XG5cdFx0Y29uc3Qge3NjcmVlbnNob3RzLCBzaXplcywgdXJsc30gPSBzdGF0cztcblx0XHRjb25zdCB3b3JkcyA9IHtcblx0XHRcdHNjcmVlbnNob3RzOiBwbHVyKCdzY3JlZW5zaG90Jywgc2NyZWVuc2hvdHMpLFxuXHRcdFx0c2l6ZXM6IHBsdXIoJ3NpemUnLCBzaXplcyksXG5cdFx0XHR1cmxzOiBwbHVyKCd1cmwnLCB1cmxzKVxuXHRcdH07XG5cblx0XHRjb25zb2xlLmxvZyhgXFxuJHtsb2dTeW1ib2xzLnN1Y2Nlc3N9IEdlbmVyYXRlZCAke3NjcmVlbnNob3RzfSAke3dvcmRzLnNjcmVlbnNob3RzfSBmcm9tICR7dXJsc30gJHt3b3Jkcy51cmxzfSBhbmQgJHtzaXplc30gJHt3b3Jkcy5zaXplc31gKTtcblx0fVxufVxuIl19